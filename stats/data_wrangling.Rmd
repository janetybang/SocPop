---
title: "SocPop data wrangling"
output: html_document
---

```{r setup, include=FALSE}

library(tidyverse)

```

```{r}
gesture <- read_csv("./data/data_190816.csv", col_names = F)%>%
  rename(start = X3,
         stop = X4,
         tier = X1,
         ant = X6, 
         file = X7)%>%
  select(file, tier, start, stop, ant)%>%
  filter(tier == "Caregiver nonlinguistic") %>% 
  mutate(id = str_sub(file, 1, 3)) %>% 
  select(-file)

label <- read_csv("./data/data_190816.csv", col_names = F)%>%
  rename(start = X3,
         stop = X4,
         tier = X1,
         ant = X6,
         file = X7)%>%
  select(file,tier, start, stop, ant)%>%
  filter(tier == "Caregiver linguistic", 
         ant != "english") %>% 
  mutate(id = str_sub(file, 1, 3)) %>% 
  select(-file)

comment <-
    list.files(path = "./comments", 
            pattern = "*.csv", 
               full.names = T) %>% 
    map_df(~read_csv(., col_types = cols(.default = "c"))) %>% 
  rename("stop" = 3, "id" = 6) %>% 
  mutate(start = as.numeric(start), 
         stop = as.numeric(stop), 
         duration = as.numeric(duration)) %>% 
  mutate(start = round(start, 3), 
         stop = round(stop, 3), 
         duration = round(duration, 3))

```

# Gesture perspective

For each gesture, does it overlap with a label?

```{r}
overlap_ges <-  gesture %>%
  mutate(start = start -1 ,
         stop = stop + 1) %>%
  group_by(id, tier, start, stop)%>%
  expand(gesture_start = nesting(label$start,label$stop,label$id))%>%
  filter(id == `label$id`)%>%
  mutate(overlap_start = ifelse(start <= `label$start` & stop >= `label$start`, T,F),
         overlap_stop = ifelse(start <= `label$stop` & stop >= `label$stop`, T,F))%>%
  group_by(id, tier, start, stop)%>%
  summarise(overlap_start = sum(overlap_start),
            overlap_stop = sum(overlap_stop))%>%
  mutate(overlap = ifelse(sum(overlap_start,overlap_stop) > 0, T,F))%>%
  group_by(id)%>%
  summarise(gestures_w_labels = sum(overlap))
         
gesture_sum <- gesture %>%
  group_by(id)%>%
  summarise(gestures = n())

label_sum <- label %>%
  group_by(id)%>%
  summarise(labels = n())

data_ges <- plyr::join_all(list(gesture_sum,label_sum,overlap_ges), by='id', type='left') %>% 
  mutate_all(~replace(., is.na(.), 0)) # this replaces NA with 0, when there no gestures or labels


write.csv(data_ges, "./data/data_ges.csv")
```

# Label perspective

For each label, does it overlap with a gesture

```{r}
overlap_label <-  label %>%
  mutate(start = start -1 ,
         stop = stop + 1)%>%
  group_by(id, tier, start, stop)%>%
  expand(gesture_start = nesting(gesture$start,gesture$stop,gesture$id))%>%
  filter(id == `gesture$id`)%>%
  mutate(overlap_start = ifelse(start <= `gesture$start` & stop >= `gesture$start`, T,F),
         overlap_stop = ifelse(start <= `gesture$stop` & stop >= `gesture$stop`, T,F))%>%
  group_by(id, tier, start, stop)%>%
  summarise(overlap_start = sum(overlap_start),
            overlap_stop = sum(overlap_stop))%>%
  mutate(overlap = ifelse(sum(overlap_start,overlap_stop) > 0, T,F))%>%
  group_by(id)%>%
  summarise(labels_w_gestures = sum(overlap))
         
gesture_sum <- gesture %>%
  group_by(id)%>%
  summarise(gestures = n())

label_sum <- label %>%
  group_by(id)%>%
  summarise(labels = n())

data_label <- plyr::join_all(list(gesture_sum,label_sum,overlap_label), by='id', type='left') %>% 
  mutate_all(~replace(., is.na(.), 0)) # this replaces NA with 0, when there no gestures or labels

write.csv(data_label, "./data/data_label.csv")
```



# Merge all gestures, labels, and comments into one dataframe

```{r}
label2 <- label %>% 
  mutate(id = str_sub(id, 1, 3)) %>%  
  mutate(start = round(start, 3), 
         stop = round(stop, 3))  %>% 
  mutate(start = as.numeric(start), 
         stop = as.numeric(stop))


comment_label <- comment %>% 
  left_join(label2, by = c("id", "start", "stop", "tier"))
write.csv(comment_label, "./data/comment_label.csv")
```

