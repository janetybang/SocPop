---
title: "SocPop Analysis"
date: "8/9/2019"
output: html_document
---

---
Import necessary packages
---
```{r setup, include=FALSE}
library(tidyverse)
library(gridExtra)
library(brms)
library(knitr)
library(ggthemes)
library(bayesplot)
library(broom)
library(readxl)
library(ggpubr)
library(lsr)
#library(sjPlot)

opts_chunk$set(echo=TRUE,
              warning=FALSE, message=FALSE,
              cache=FALSE)
```

## Read in data and create one dataframe with demographic and outcome information, assuming you already ran data_wrangling!
```{r}
data_label <- read_csv("./data/data_label.csv") %>% 
  select(-X1 )
comment_label <- read_csv("./data/comment_label.csv")

data <- read_excel("./data/data_children_n42.xlsx") %>% 
  mutate(id = as.character(id)) %>% 
  select(c(id, L1PRE_mom_ed,
           L1PRE_hi, L1POST_hi,
           L1PRE_gooddrt, L1POST_gooddrt,
           L1PRE_cdi_age, L1PRE_cdi_vocab, L1POST_cdi_age, L1POST_cdi_vocab, 
           L1PRE_PS_AWChr)) %>% 
  rename(rt_18m = L1PRE_gooddrt, cdi_18m = L1PRE_cdi_vocab,
         rt_25m = L1POST_gooddrt, cdi_25m = L1POST_cdi_vocab,
         ses_18m = L1PRE_hi, ses_25m = L1POST_hi, awc_phr_18m = L1PRE_PS_AWChr, 
         mom_ed_18m = L1PRE_mom_ed, 
         cdi_age_18m = L1PRE_cdi_age, cdi_age_25m = L1POST_cdi_age)


data_overlap <- read_csv("data/elan_Comments_Update.csv")%>%
  filter(tier == "Caregiver linguistic")%>%
  mutate(id = subject, 
         id = ifelse(id == "84", "084",id))%>%
  group_by(id)%>%
  summarise(labels_rel = n(),
            labels_w_rel_gestures = sum(as.numeric(relavence)))

# merge into 1 dataframe
socpop <- data_label %>% 
  full_join(data, by = "id")%>%
  full_join(data_overlap, by = "id")

# check for discrepancies between label outputs
socpop %>% left_join(data_overlap)%>%
  select(id, labels, labels_rel)%>%
  mutate(label_diff = labels - labels_rel)

socpop_rel <- data_overlap %>% 
  full_join(data, by = "id") %>% 
  mutate(labels_rel = replace_na(labels_rel, 0)) %>% 
  mutate(labels_w_rel_gestures = replace_na(labels_w_rel_gestures, 0))

```

## Visualizing raw correlations

### Within predictors

```{r}
# I added the LENA AWC count to see if total labels is related to just parents talking more overall in the play sessions, which it is (like we would expect)

cor <- socpop%>%
  select(gestures, labels, labels_w_gestures,labels_rel,labels_w_rel_gestures, awc_phr_18m) %>%
  as.matrix()

correlate(cor)

```


### Predictors vs DVs

```{r}
socpop %>%
  select(id, gestures, labels,labels_w_gestures, labels_rel,labels_w_rel_gestures, rt_25m, cdi_25m)%>%
  gather(DV, y, -id, -gestures,-labels_w_gestures, -labels, -labels_rel, -labels_w_rel_gestures)%>%
  gather(input, freq, -id, -DV, -y)%>%
  mutate(DV = factor(DV, levels = c("rt_25m", "cdi_25m")), 
         input = factor(input, levels = c("labels", "gestures", "labels_w_gestures", "labels_rel","labels_w_rel_gestures"))) %>%
  ggplot(aes(x = freq, y = y))+
  geom_point()+
  facet_grid(DV~input, scales = "free")+
  geom_smooth(method = "lm")+
  stat_cor(method = "pearson", hjust = -1.2, vjust = .5)+
  labs(y = "Vocabulary Size at 25m          Speed of Processing (ms) at 25m", x = "Frequency") + 
  theme_few(base_size = 18)

ggsave("./figures/scatterplot_zero_order_correlations_n36.png", height = 8, width = 12, units = "in")

```


## Models

### Reaction time as dependent variable

```{r}
# Prepare data file
# center predictors at 0 by subtracting mean to facilitate model fitting
# remove lines with NAs to allow centering

data_model <- socpop %>%
  filter(rt_25m != "NA",
         gestures != "NA",
         labels != "NA")%>%
  mutate(gestures = scale(gestures, center = TRUE, scale = TRUE),
         labels = scale(labels, center = TRUE, scale = TRUE),
         labels_w_gestures = scale(labels_w_gestures, center = TRUE, scale = TRUE),
         rt_18m = scale(rt_18m, center = TRUE, scale = TRUE),
         ses_18m = scale(ses_18m, center = TRUE, scale = TRUE))

```

#### Plotting DV

```{r}
# inspect DV - looks fine in this case
ggplot(data_model, aes(x=rt_25m))+
  geom_density()+
  xlim(0,2000)+
  theme_few()
```

#### Plotting IV

```{r}
ggplot(data_model, aes(x=rt_18m))+
  geom_density()+
  theme_few()
```

#### Models RT

```{r}
# run models only when new data is added
# otherwise, you can just load the saved model output
# saves time, each model takes approx. 2 min to run
# when you run the model, the output is automatically saved
# even if you run the model, you need to load the saved file afterwards

 

model_rt_label <- readRDS("saves/model_rt_label.rds")

# prior_rt_gesture <- c(set_prior("normal(750,400)", class = "b", coef = "intercept"),
#             set_prior("normal(0,10)", class = "b", coef = "gestures"),
#             set_prior("normal(0,10)", class = "b", coef = "ses_18m"),
#             set_prior("normal(0,10)", class = "b", coef = "rt_18m"))
# 
# model_rt_gesture <- brm(rt_25m ~gestures + ses_18m + rt_18m,
#                     data = data_model, family = gaussian(),
#           control = list(adapt_delta = 0.95),
#           save_all_pars = TRUE,
#           #prior = prior_rt_gesture,
#           chains = 4,
#           cores = 4,
#           iter = 50000)%>%
#   add_criterion("waic")%>%
#  saveRDS("saves/model_rt_gesture.rds")

model_rt_gesture <- readRDS("saves/model_rt_gesture.rds")

# prior_rt_label_gesture <- c(set_prior("normal(750,400)", class = "b", coef = "intercept"),
#             set_prior("normal(0,10)", class = "b", coef = "gestures"),
#             set_prior("normal(0,10)", class = "b", coef = "labels"),
#             set_prior("normal(0,10)", class = "b", coef = "ses_18m"),
#             set_prior("normal(0,10)", class = "b", coef = "rt_18m"))
# 
# model_rt_label_gesture <- brm(rt_25m ~ labels + gestures + ses_18m + rt_18m,
#                     data = data_model, family = gaussian(),
#           control = list(adapt_delta = 0.95),
#           save_all_pars = TRUE,
#           #prior = prior_rt_label_gesture,
#           chains = 4,
#           cores = 4,
#           iter = 50000)%>%
#   add_criterion("waic")%>%
#   saveRDS("saves/model_rt_label_gesture.rds")

model_rt_label_gesture <- readRDS("saves/model_rt_label_gesture.rds")

# prior_rt_label_gesture_int <- c(set_prior("normal(750,400)", class = "b", coef = "intercept"),
#             set_prior("normal(0,10)", class = "b", coef = "gestures"),
#             set_prior("normal(0,10)", class = "b", coef = "labels"),
#             set_prior("normal(0,10)", class = "b", coef = "labels:gestures"),
#             set_prior("normal(0,10)", class = "b", coef = "ses_18m"),
#             set_prior("normal(0,10)", class = "b", coef = "rt_18m"))
# 
# model_rt_label_gesture_int <- brm(rt_25m ~labels * gestures + ses_18m + rt_18m,
#                     data = data_model, family = gaussian(),
#           control = list(adapt_delta = 0.95),
#           save_all_pars = TRUE,
#           #prior = prior_rt_label_gesture_int,
#           chains = 4,
#           cores = 4,
#           iter = 50000)%>%
#   add_criterion("waic")%>%
#   saveRDS("saves/model_rt_label_gesture_int.rds")

model_rt_label_gesture_int <- readRDS("saves/model_rt_label_gesture_int.rds")

# prior_rt_overlap <- c(set_prior("normal(750,400)", class = "b", coef = "intercept"),
#             set_prior("normal(0,10)", class = "b", coef = "labels_w_gestures"),
#             set_prior("normal(0,10)", class = "b", coef = "ses_18m"),
#             set_prior("normal(0,10)", class = "b", coef = "rt_18m"))
# 
# model_rt_overlap <- brm(rt_25m ~ labels_w_gestures + ses_18m + rt_18m,
#                     data = data_model, family = gaussian(),
#           control = list(adapt_delta = 0.95),
#           save_all_pars = TRUE,
#           #prior = prior_rt_overlap,
#           chains = 4,
#           cores = 4,
#           iter = 50000)%>%
#   add_criterion("waic")%>%
#   saveRDS("saves/model_rt_overlap.rds")

model_rt_overlap <- readRDS("saves/model_rt_overlap.rds")


# model_rt_null <- brm(rt_25m ~ ses_18m + rt_18m,
#                     data = data_model, family = gaussian(),
#           control = list(adapt_delta = 0.95),
#           save_all_pars = TRUE,
#           #prior = prior_rt_overlap,
#           chains = 4,
#           cores = 4,
#           iter = 50000)%>%
#   add_criterion("waic")%>%
#   saveRDS("saves/model_rt_null.rds")

model_rt_null <- readRDS("saves/model_rt_null.rds")

```

#### Model comparison
```{r}
# inspect trace plots for models
# looks fine, check again when new data was added

# plot(model_rt_label)
# 
# plot(model_rt_gesture)
# 
# plot(model_rt_label_gesture)
# 
# plot(model_rt_label_gesture_int)
# 
# plot(model_rt_overlap)

```

#### Visualizing results

```{r}
# overview over model predictors
# removing intercept because it's on a different scale
# select models depending on results of model comparison

bind_rows(
tidy(model_rt_label, prob = 0.95)%>%mutate(model = "label"),
tidy(model_rt_gesture, prob = 0.95)%>%mutate(model = "gesture"),
tidy(model_rt_overlap, prob = 0.95)%>%mutate(model = "overlap"),
tidy(model_rt_label_gesture, prob = 0.95)%>%mutate(model = "label+gesture"),
tidy(model_rt_label_gesture_int, prob = 0.95)%>%mutate(model = "label*gesture"),
tidy(model_rt_null, prob = 0.95)%>%mutate(model = "null")
) %>%
  filter(term != "b_Intercept",
         term != "Intercept",
         term != "b_intercept",
         term != "sigma",
         term != "temp_Intercept",
         term != "lp__")%>% 
  mutate(term = str_remove(term,"b_"))%>%
  ggplot(aes(term, estimate, ymin = lower, ymax = upper, color = model)) + 
  geom_hline(yintercept=0)+
  geom_pointrange(position = position_dodge(width = .8))+
  coord_flip()+
  theme_few()+
  scale_color_ptol(name = "Model")
  
```

#### Bayes Factors
```{r}

bf_rt_1 <- bayes_factor(model_rt_label, model_rt_label_gesture, log = F)
bf_rt_2 <- bayes_factor(model_rt_label, model_rt_label_gesture_int, log = F)
bf_rt_3 <- bayes_factor(model_rt_label, model_rt_overlap, log = F)
bf_rt_4 <- bayes_factor(model_rt_label, model_rt_gesture, log = F)

```

#### Overview table

```{r}
# Putting things together in a dataframe
# BF = Bayes factor in favor of the winning model in this case label

loo_compare(model_rt_label, 
                    model_rt_gesture,
                    model_rt_label_gesture,
                    model_rt_label_gesture_int,
                    model_rt_overlap,
            model_rt_null,
            criterion = "waic")%>%
  as.data.frame()%>%
  tibble::rownames_to_column("Model")%>%
  mutate(Model = str_replace(Model, "model_rt_", ""),
         #bf = c(NA,bf_rt_1$bf,bf_rt_2$bf,bf_rt_3$bf,bf_rt_4$bf),
         #bf = round(bf,2),
         waic = round(waic, 2),
         se_waic = round(se_waic, 2),
         weight = exp(elpd_waic)/sum(exp(elpd_waic)),
         weight = round(weight, 3))%>%
  select(Model, waic, se_waic, weight)%>%
  saveRDS("saves/rt_overview.rds")

readRDS("saves/rt_overview.rds")

```



### CDI as dependent variable

```{r}
# Prepare data file
# center predictors at 0 by subtracting mean to facilitate model fitting
# remove lines with NAs to allow centering

data_cdi_model <- socpop %>%
  filter(cdi_18m != "NA",
         cdi_25m != "NA",
         gestures != "NA",
         labels != "NA")%>%
  mutate(gestures = scale(gestures, center = TRUE, scale = TRUE),
         labels = scale(labels, center = TRUE, scale = TRUE),
         labels_w_gestures = scale(labels_w_gestures, center = TRUE, scale = TRUE),
         cdi_18m = scale(cdi_18m, center = TRUE, scale = TRUE),
         ses_18m = scale(ses_18m, center = TRUE, scale = TRUE))
```

#### Plotting DV

```{r}
# inspect DV - looks fine in this case
ggplot(data_cdi_model, aes(x=cdi_25m))+
  geom_density()+
  xlim(-1000,1000)+
  theme_few()
```

#### Models CDI

```{r}
# run models only when new data is added
# otherwise, you can just load the saved model output
# saves time, each model takes approx. 2 min to run
# when you run the model, the output is automatically saved
# even if you run the model, you need to load the saved file afterwards


# prior_cdi_label <- c(set_prior("normal(250,300)", class = "b", coef = "intercept"),
#             set_prior("normal(0,10)", class = "b", coef = "labels"),
#             set_prior("normal(0,10)", class = "b", coef = "ses_18m"),
#             set_prior("normal(0,10)", class = "b", coef = "cdi_18m"))
# 
# 
# model_cdi_label <- brm(cdi_25m ~ labels + ses_18m +cdi_18m,
#                     data = data_cdi_model, family = gaussian(),
#           control = list(adapt_delta = 0.95),
#           save_all_pars = TRUE,
#           #prior = prior_cdi_label,
#           chains = 4,
#           cores = 4,
#           iter = 50000)%>%
#   add_criterion("waic")%>%
#   saveRDS("saves/model_cdi_label.rds")

model_cdi_label <- readRDS("saves/model_cdi_label.rds")

# prior_cdi_gesture <- c(set_prior("normal(250,300)", class = "b", coef = "intercept"),
#             set_prior("normal(0,10)", class = "b", coef = "gestures"),
#             set_prior("normal(0,10)", class = "b", coef = "ses_18m"),
#             set_prior("normal(0,10)", class = "b", coef = "cdi_18m"))
# 
# model_cdi_gesture <- brm(cdi_25m ~ gestures + ses_18m +cdi_18m,
#                     data = data_cdi_model, family = gaussian(),
#           control = list(adapt_delta = 0.95),
#           save_all_pars = TRUE,
#           #prior = prior_cdi_gesture,
#           chains = 4,
#           cores = 4,
#           iter = 50000)%>%
#   add_criterion("waic")%>%
#   saveRDS("saves/model_cdi_gesture.rds")

model_cdi_gesture <- readRDS("saves/model_cdi_gesture.rds")

# prior_cdi_label_gesture <- c(set_prior("normal(250,300)", class = "b", coef = "intercept"),
#             set_prior("normal(0,10)", class = "b", coef = "gestures"),
#             set_prior("normal(0,10)", class = "b", coef = "labels"),
#             set_prior("normal(0,10)", class = "b", coef = "ses_18m"),
#             set_prior("normal(0,10)", class = "b", coef = "cdi_18m"))
# 
# model_cdi_label_gesture <- brm(cdi_25m ~ labels + gestures + ses_18m +cdi_18m,
#                     data = data_cdi_model, family = gaussian(),
#           control = list(adapt_delta = 0.95),
#           save_all_pars = TRUE,
#           #prior = prior_cdi_label_gesture,
#           chains = 4,
#           cores = 4,
#           iter = 50000)%>%
#   add_criterion("waic")%>%
#   saveRDS("saves/model_cdi_label_gesture.rds")

model_cdi_label_gesture <- readRDS("saves/model_cdi_label_gesture.rds")

# prior_cdi_label_gesture_int <- c(set_prior("normal(250,300)", class = "b", coef = "intercept"),
#             set_prior("normal(0,10)", class = "b", coef = "gestures"),
#             set_prior("normal(0,10)", class = "b", coef = "labels"),
#             set_prior("normal(0,10)", class = "b", coef = "labels:gestures"),
#             set_prior("normal(0,10)", class = "b", coef = "ses_18m"),
#             set_prior("normal(0,10)", class = "b", coef = "cdi_18m"))
# 
# model_cdi_label_gesture_int <- brm(cdi_25m ~ labels * gestures + ses_18m +cdi_18m,
#                     data = data_cdi_model, family = gaussian(),
#           control = list(adapt_delta = 0.95),
#           save_all_pars = TRUE,
#           #prior = prior_cdi_label_gesture_int,
#           chains = 4,
#           cores = 4,
#           iter = 50000)%>%
#   add_criterion("waic")%>%
#   saveRDS("saves/model_cdi_label_gesture_int.rds")

model_cdi_label_gesture_int <- readRDS("saves/model_cdi_label_gesture_int.rds")

# prior_cdi_overlap <- c(set_prior("normal(250,300)", class = "b", coef = "intercept"),
#             set_prior("normal(0,10)", class = "b", coef = "labels_w_gestures"),
#             set_prior("normal(0,10)", class = "b", coef = "ses_18m"),
#             set_prior("normal(0,10)", class = "b", coef = "cdi_18m"))
# 
# model_cdi_overlap <- brm(cdi_25m ~ labels_w_gestures + ses_18m + cdi_18m,
#                     data = data_cdi_model, family = gaussian(),
#           control = list(adapt_delta = 0.95),
#           save_all_pars = TRUE,
#           #prior = prior_cdi_overlap,
#           chains = 4,
#           cores = 4,
#           iter = 50000)%>%
#   add_criterion("waic")%>%
#   saveRDS("saves/model_cdi_overlap.rds")

model_cdi_overlap <- readRDS("saves/model_cdi_overlap.rds")


# model_cdi_null <- brm(cdi_25m ~  ses_18m + cdi_18m,
#                     data = data_cdi_model, family = gaussian(),
#           control = list(adapt_delta = 0.95),
#           save_all_pars = TRUE,
#           #prior = prior_cdi_overlap,
#           chains = 4,
#           cores = 4,
#           iter = 50000)%>%
#   add_criterion("waic")%>%
#   saveRDS("saves/model_cdi_null.rds")

model_cdi_null <- readRDS("saves/model_cdi_null.rds")

```


#### Model comparison

```{r}
# inspect trace plots for models
# looks fine, check again when new data was added

# plot(model_rt_label)
# 
# plot(model_rt_gesture)
# 
# plot(model_rt_label_gesture)
# 
# plot(model_rt_label_gesture_int)
# 
# plot(model_rt_overlap)
```

#### Visualizing results

```{r}
# overview over model predictors
# removing intercept because it's on a different scale
# select models depending on results of model comparison

bind_rows(
tidy(model_cdi_label, prob = 0.95)%>%mutate(model = "label"),
tidy(model_cdi_gesture, prob = 0.95)%>%mutate(model = "gesture"),
tidy(model_cdi_overlap, prob = 0.95)%>%mutate(model = "overlap"),
tidy(model_cdi_label_gesture, prob = 0.95)%>%mutate(model = "label+gesture"),
tidy(model_cdi_label_gesture_int, prob = 0.95)%>%mutate(model = "label*gesture"),
tidy(model_cdi_null, prob = 0.95)%>%mutate(model = "null")
) %>%
  filter(term != "Intercept",
         term != "b_Intercept",
         term != "b_intercept",
         term != "sigma",
         term != "temp_Intercept",
         term != "lp__")%>% 
  mutate(term = str_remove(term,"b_"))%>%
  ggplot(aes(term, estimate, ymin = lower, ymax = upper, color = model)) + 
  geom_hline(yintercept=0)+
  geom_pointrange(position = position_dodge(width = .8))+
  coord_flip()+
  theme_few()+
  scale_color_ptol(name = "Model")
  
```

#### Bayes Factors
```{r}

bf_cdi_1 <- bayes_factor(model_cdi_label, model_cdi_overlap, log = F)
bf_cdi_2 <- bayes_factor(model_cdi_label, model_cdi_gesture, log = F)
bf_cdi_3 <- bayes_factor(model_cdi_label, model_cdi_label_gesture, log = F)
bf_cdi_4 <- bayes_factor(model_cdi_label, model_cdi_label_gesture_int, log = F)

```

#### Overview table

```{r}
# Putting things together in a dataframe
# BF = Bayes Factor in favor of the winning model, in this case overlap

loo_compare(model_cdi_label, 
                    model_cdi_gesture,
                    model_cdi_label_gesture,
                    model_cdi_label_gesture_int,
                    model_cdi_overlap,
            model_cdi_null,
            criterion = "waic")%>%
  as.data.frame()%>%
  tibble::rownames_to_column("Model")%>%
  mutate(Model = str_replace(Model, "model_cdi_", ""),
         waic = round(waic, 2),
         se_waic = round(se_waic, 2),
         weight = exp(elpd_waic)/sum(exp(elpd_waic)),
         weight = round(weight, 3)
         #bf = c("-", round(bf_cdi_1$bf,2),round(bf_cdi_3$bf,2),round(bf_cdi_4$bf,2),round(bf_cdi_1$bf,2))
         )%>%
  select(Model, waic, se_waic, weight)%>%
  saveRDS("saves/cdi_overview.rds")


readRDS("saves/cdi_overview.rds")
```



### Plotting interaction of label and gesture
```{r}
# this model shows that gestures matter more for cdi when you have fewer label
plot_model(model_cdi_label_gesture_int, type = "pred", terms = c("gestures", "labels"))

```




